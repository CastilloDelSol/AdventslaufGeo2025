<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>H3 Hexagon Heatmap</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      border-radius: 5px;
      font-size: 14px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }

    /* Dark mode button */
    .dark-toggle {
      background: white;
      padding: 6px 10px;
      border: 1px solid #999;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
      font-size: 13px;
    }
    .dark-toggle:hover {
      background: #eee;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
// ------------------------------------------------------------
// INITIAL MAP (center on your coords)
// 200 km diameter â‰ˆ zoom 8
// ------------------------------------------------------------
const map = L.map('map').setView([53.699327, 10.774143], 10);


// ------------------------------------------------------------
// LIGHT TILE LAYER (default)
// ------------------------------------------------------------
const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);


// ------------------------------------------------------------
// DARK TILE LAYER (toggleable)
// ------------------------------------------------------------
const darkTiles = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  {
    attribution: '&copy; OpenStreetMap & CARTO',
    maxZoom: 19
  }
);

let darkMode = false;


// ------------------------------------------------------------
// DARK MODE BUTTON (placed next to zoom control)
// ------------------------------------------------------------
const darkButton = L.control({position: 'topleft'});
darkButton.onAdd = function() {
  const div = L.DomUtil.create('div', 'dark-toggle');
  div.innerHTML = "Dark Mode";
  div.onclick = () => {
    if (!darkMode) {
      map.removeLayer(lightTiles);
      darkTiles.addTo(map);
      darkMode = true;
      div.innerHTML = "Light Mode";
    } else {
      map.removeLayer(darkTiles);
      lightTiles.addTo(map);
      darkMode = false;
      div.innerHTML = "Dark Mode";
    }
  };
  return div;
};
darkButton.addTo(map);


// ------------------------------------------------------------
// COLOR SCALE
// ------------------------------------------------------------
function getColor(count) {
  return count > 20 ? '#800026' :
         count > 10 ? '#BD0026' :
         count > 5  ? '#E31A1C' :
         count > 2  ? '#FD8D3C' :
         count > 1  ? '#FEB24C' :
         count > 0  ? '#FED976' :
                      '#FFEDA0';
}

function style(feature) {
  return {
    fillColor: getColor(feature.properties.count),
    weight: 1,
    opacity: 0.7,
    color: '#333',
    fillOpacity: 0.55
  };
}


// ------------------------------------------------------------
// LAYER GROUPS FOR r6,r7,r8,r9
// ------------------------------------------------------------
const layers = {
  "Resolution 6": L.layerGroup(),
  "Resolution 7": L.layerGroup(),
  "Resolution 8": L.layerGroup(),
  "Resolution 9": L.layerGroup()
};

const resolutionFiles = {
  "Resolution 6": "hexagons_r6.geojson",
  "Resolution 7": "hexagons_r7.geojson",
  "Resolution 8": "hexagons_r8.geojson",
  "Resolution 9": "hexagons_r9.geojson"
};


// ------------------------------------------------------------
// LOAD GEOJSON LAYERS
// ------------------------------------------------------------
for (const [name, file] of Object.entries(resolutionFiles)) {

  fetch(file)
    .then(r => r.json())
    .then(data => {

      const layer = L.geoJSON(data, {
        style: style,
        onEachFeature: function(feature, layer) {
          layer.bindTooltip(`Count: ${feature.properties.count}`, {
            sticky: true
          });
        }
      });

      layer.addTo(layers[name]);

      if (name === "Resolution 8") {
        layers[name].addTo(map); // default visible
      }
    });
}


// ------------------------------------------------------------
// PERMANENTLY OPEN LAYER SWITCHER
// ------------------------------------------------------------
const switcher = L.control.layers(null, layers, {
  collapsed: false   // <-- ALWAYS OPEN
});
switcher.addTo(map);


// ------------------------------------------------------------
// LEGEND
// ------------------------------------------------------------
const legend = L.control({ position: "bottomright" });

legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  const grades = [0, 1, 2, 5, 10, 20];
  div.innerHTML += "<b>Teilnehmer pro Hexagon</b><br>";

  for (let i = 0; i < grades.length; i++) {
    div.innerHTML +=
      '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
      grades[i] +
      (grades[i + 1] ? "&ndash;" + grades[i + 1] + "<br>" : "+");
  }
  return div;
};

legend.addTo(map);


// ------------------------------------------------------------
// FUTURE STATISTICS JSON (optional)
// ------------------------------------------------------------
fetch("statistics.json")
  .then(r => r.json())
  .then(stats => console.log("Statistics loaded", stats))
  .catch(() => console.log("No statistics.json (ok)"));

// ------------------------------------------------------------
</script>
</body>
</html>
