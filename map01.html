<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>H3 Hexagon Heatmap</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      border-radius: 5px;
      font-size: 14px;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
// ------------------------------------------------------------
// BASE MAP
// ------------------------------------------------------------
const map = L.map('map').setView([53.699288, 10.774134], 8);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);


// ------------------------------------------------------------
// COLOR SCALE
// ------------------------------------------------------------
function getColor(count) {
  return count > 20 ? '#800026' :
         count > 10 ? '#BD0026' :
         count > 5  ? '#E31A1C' :
         count > 2  ? '#FD8D3C' :
         count > 1  ? '#FEB24C' :
         count > 0  ? '#FED976' :
                      '#FFEDA0';
}

function style(feature) {
  return {
    fillColor: getColor(feature.properties.count),
    weight: 1,
    opacity: 0.7,
    color: '#333',
    fillOpacity: 0.55
  };
}


// ------------------------------------------------------------
// CREATE LAYER GROUPS FOR r6,r7,r8,r9
// ------------------------------------------------------------
const layers = {
  "Resolution 6": L.layerGroup(),
  "Resolution 7": L.layerGroup(),
  "Resolution 8": L.layerGroup(),
  "Resolution 9": L.layerGroup()
};

const resolutionFiles = {
  "Resolution 6": "hexagons_r6.geojson",
  "Resolution 7": "hexagons_r7.geojson",
  "Resolution 8": "hexagons_r8.geojson",
  "Resolution 9": "hexagons_r9.geojson"
};


// ------------------------------------------------------------
// LOAD ALL GEOJSON LAYERS
// ------------------------------------------------------------
for (const [name, file] of Object.entries(resolutionFiles)) {

  fetch(file)
    .then(r => r.json())
    .then(data => {

      const layer = L.geoJSON(data, {
        style: style,
        onEachFeature: function (feature, layer) {
          // MOUSE HOVER POPUP
          layer.bindTooltip(
            `Count: ${feature.properties.count}`,
            { sticky: true }
          );
        }
      });

      layer.addTo(layers[name]);  // Add to layerGroup
      if (name === "Resolution 8") {
        layers[name].addTo(map);  // Default visible layer
        map.fitBounds(layer.getBounds());
      }
    });
}


// ------------------------------------------------------------
// LAYER SWITCH CONTROL
// ------------------------------------------------------------
L.control.layers(null, layers).addTo(map);


// ------------------------------------------------------------
// LEGEND
// ------------------------------------------------------------
const legend = L.control({ position: "bottomright" });

legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  const grades = [0, 1, 2, 5, 10, 20];
  div.innerHTML += "<b>Teilnehmer pro Hexagon</b><br>";

  for (let i = 0; i < grades.length; i++) {
    div.innerHTML +=
      '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
      grades[i] +
      (grades[i + 1] ? "&ndash;" + grades[i + 1] + "<br>" : "+");
  }
  return div;
};

legend.addTo(map);


// ------------------------------------------------------------
// STATISTICS JSON (future)
// ------------------------------------------------------------
// Example: statistics.json (you will generate this later)
// {
//   "total_participants": 287,
//   "individual_addresses": 233,
//   "top3_hexagons": [
//      {"hex": "8bf123...", "count": 17},
//      {"hex": "8bf456...", "count": 16},
//      {"hex": "8bf789...", "count": 14}
//   ],
//   "median_distance_km": 7.21,
//   "average_distance_km": 8.44
// }

fetch("statistics.json")
  .then(r => r.json())
  .then(stats => {
    console.log("Statistics loaded:", stats);
    // You can display this in a sidebar or popup later
  })
  .catch(e => console.log("No statistics.json yet â†’ OK"));
</script>

</body>
</html>
