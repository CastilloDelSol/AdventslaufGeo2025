<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Statistik – Ratzeburger Adventslauf</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { margin:0; padding:0; background:#f5f6fa; font-family:system-ui,sans-serif; color:#222; }
    header { background:#334; color:white; padding:20px 40px; font-size:26px; font-weight:600; text-align:center; }
    .container { max-width:1100px; margin:30px auto; padding:0 20px; }

    .kpi-grid {
        display:grid; gap:18px;
        grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    }
    .kpi {
        background:white; border-radius:10px;
        padding:18px; text-align:center;
        box-shadow:0 2px 8px rgba(0,0,0,0.12);
    }
    .kpi-title { font-size:14px; opacity:0.7; }
    .kpi-value { font-size:26px; margin-top:6px; font-weight:700; }

    h2 { margin-top:40px; font-size:24px; }

    .chart-card {
        background:white; padding:20px; border-radius:10px;
        box-shadow:0 2px 8px rgba(0,0,0,0.12); margin-top:20px;
    }

    .hotspot {
        background:white; padding:16px; border-radius:10px;
        box-shadow:0 2px 8px rgba(0,0,0,0.12);
        margin-top:20px;
    }

    @media (max-width:600px){
        header { font-size:22px; padding:16px; }
        .kpi-value { font-size:22px; }
    }
</style>
</head>

<body>

<header>Statistik – Ratzeburger Adventslauf</header>

<div class="container">

    <!-- KPIs -->
    <div id="kpis" class="kpi-grid"></div>

    <h2>Distanzen nach Kategorien</h2>
    <div class="chart-card">
        <canvas id="bucketBar"></canvas>
    </div>

    <h2>Wind-Rose (klickbar)</h2>
    <div class="chart-card">
        <canvas id="windRose"></canvas>
    </div>

    <h2>Distanz-Buckets für gewählte Richtung</h2>
    <div class="chart-card">
        <canvas id="directionBuckets"></canvas>
    </div>

    <h2>Top-3 Hexagon-Hotspots (r7)</h2>
    <div id="hotspots" class="hotspot"></div>

</div>

<script>
// ------------------------------------------------------------
// LOAD statistics.json
// ------------------------------------------------------------
fetch("statistics.json")
  .then(r => r.json())
  .then(stats => {

    // ------------------- KPI BOXES ------------------------
    document.getElementById("kpis").innerHTML = `
        <div class="kpi"><div class="kpi-title">Teilnehmer</div><div class="kpi-value">${stats.total_participants}</div></div>
        <div class="kpi"><div class="kpi-title">Distanz min</div><div class="kpi-value">${stats.distance_min_km} km</div></div>
        <div class="kpi"><div class="kpi-title">Distanz max</div><div class="kpi-value">${stats.distance_max_km} km</div></div>
        <div class="kpi"><div class="kpi-title">Ø Distanz</div><div class="kpi-value">${stats.distance_avg_km} km</div></div>
        <div class="kpi"><div class="kpi-title">Median</div><div class="kpi-value">${stats.distance_median_km} km</div></div>
    `;

    // ------------------- GLOBAL BUCKET BAR CHART -----------------
    const bucketLabels = Object.keys(stats.distance_buckets);
    const bucketValues = Object.values(stats.distance_buckets);

    new Chart(document.getElementById("bucketBar"), {
        type:"bar",
        data:{
            labels:bucketLabels,
            datasets:[{
                label:"Teilnehmer",
                data:bucketValues,
                backgroundColor:"rgba(20,60,160,0.55)",
                borderRadius:4
            }]
        },
        options:{
            scales:{ y:{beginAtZero:true} }
        }
    });

    // ------------------- WIND ROSE -------------------------
    const dirs = Object.keys(stats.wind_rose);
    const vals = Object.values(stats.wind_rose);

    const windChart = new Chart(document.getElementById("windRose"), {
        type:"radar",
        data:{
            labels:dirs,
            datasets:[{
                label:"Teilnehmer",
                data:vals,
                backgroundColor:"rgba(50,100,200,0.3)",
                borderColor:"rgba(20,60,160,0.9)",
                borderWidth:2
            }]
        },
        options:{
            onClick:(evt, active)=>{
                if (!active.length) return;
                const idx = active[0].index;
                const dir = dirs[idx];
                showBucketsForDirection(dir);
            },
            scales:{ r:{beginAtZero:true, ticks:{display:false}} }
        }
    });

    // ------------------- PER-DIRECTION BUCKETS -------------------
    const rawDistances  = stats.raw_distances  || [];
    const rawDirections = stats.raw_directions || [];

    // Hilfsfunktion: Buckets für EINE Richtung berechnen
    function computeBucketsForDirection(dir) {
        const buckets = {
            "<10 km":0,
            "10-25 km":0,
            "25-50 km":0,
            "50-100 km":0,
            "100-250 km":0,
            ">250 km":0
        };

        for (let i = 0; i < rawDistances.length; i++) {
            if (rawDirections[i] !== dir) continue;
            const d = rawDistances[i];
            if (d < 10) buckets["<10 km"]++;
            else if (d < 25) buckets["10-25 km"]++;
            else if (d < 50) buckets["25-50 km"]++;
            else if (d < 100) buckets["50-100 km"]++;
            else if (d < 250) buckets["100-250 km"]++;
            else buckets[">250 km"]++;
        }
        return buckets;
    }

    // Chart-Instanz für die gewählte Richtung
    let directionChart = null;

    function showBucketsForDirection(dir) {
        const data = computeBucketsForDirection(dir);
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (directionChart) directionChart.destroy();

        directionChart = new Chart(document.getElementById("directionBuckets"), {
            type:"bar",
            data:{
                labels:labels,
                datasets:[{
                    label:"Teilnehmer in Richtung " + dir,
                    data:values,
                    backgroundColor:"rgba(0,140,70,0.65)",
                    borderRadius:4
                }]
            },
            options:{
                scales:{ y:{beginAtZero:true} }
            }
        });
    }

    // optional: initial irgend eine Richtung anzeigen (z.B. WSW oder N)
    if (dirs.length > 0 && rawDistances.length > 0) {
        showBucketsForDirection(dirs[0]);
    }

    // ------------------- TOP 3 HOTSPOTS ---------------------
    document.getElementById("hotspots").innerHTML =
        stats.top3_hexagons_r7
          .map((hx,i)=>`
             <div>
               <b>#${i+1}</b> – ${hx.count} Teilnehmer<br>
               <code>${hx.h3_id}</code>
             </div><br>
          `)
          .join("");

  })
  .catch(err => {
    console.error("Fehler beim Laden von statistics.json:", err);
  });
</script>

</body>
</html>
