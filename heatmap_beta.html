<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hexagon-Heatmap – Ratzeburger Adventslauf 2025</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>

<style>
/* ------------------------------------------------------ */
/* GLOBAL STYLES                                           */
/* ------------------------------------------------------ */
html, body, #map {
  height: 100%;
  margin: 0;
  padding: 0;
}

body, .legend, .stats-box, .leaflet-container {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, Helvetica, Arial, sans-serif;
}

/* ------------------------------------------------------ */
/* COPYRIGHT + DSGVO BUTTON (unten links)                 */
/* ------------------------------------------------------ */
.copyright-box {
  position: absolute;
  bottom: 20px;
  left: 20px;
  background: white;
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 18px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  z-index: 9901;
  max-width: 240px;
}

.copyright-box a {
  color: #0078ff;
  font-weight: 600;
  cursor: pointer;
}

#privacyBox {
  display:none;
  position: fixed;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%);
  background:white;
  padding:20px;
  border-radius:10px;
  width: 320px;
  max-width:90%;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
  z-index:99999;
}
#privacyBox button{
  margin-top:15px;
  padding:8px 12px;
  cursor:pointer;
}

/* ------------------------------------------------------ */
/* LEGEND (unten rechts)                                  */
/* ------------------------------------------------------ */
.legend {
  background: white;
  padding: 10px;
  line-height: 18px;
  border-radius: 6px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.legend i {
  width: 18px;
  height: 18px;
  float: left;
  margin-right: 8px;
  opacity: 0.85;
  border-radius: 3px;
}

/* ------------------------------------------------------ */
/* BUTTONS RECHTS (Dark Mode, r7, r8)                     */
/* ------------------------------------------------------ */
.right-buttons {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 9902;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.map-button {
  background:white;
  padding: 8px 14px;
  border-radius:6px;
  border:1px solid #999;
  cursor:pointer;
  font-size:14px;
  box-shadow:0 2px 4px rgba(0,0,0,0.25);
  min-width:130px;
  text-align:center;
}
.map-button:hover{
  background:#f0f0f0;
}
.map-button.active{
  background:#0078ff;
  color:white;
  border-color:#005fcc;
}

/* ------------------------------------------------------ */
/* TOOLTIP                                                */
/* ------------------------------------------------------ */
.leaflet-tooltip {
  font-size: 13px;
  font-weight: 500;
}

</style>
</head>

<body>

<div id="map"></div>

<!-- RIGHT BUTTON PANEL -->
<div class="right-buttons">
  <div id="btnDark" class="map-button">Dark Mode</div>
  <div id="btnR7" class="map-button active">Auflösung 7</div>
  <div id="btnR8" class="map-button">Auflösung 8</div>
</div>

<!-- COPYRIGHT + DSGVO -->
<div class="copyright-box">
  © 2025 Ratzeburger Adventslauf<br>
  Visualisierung & Datenaggregation: Tim Sonnenburg<br>
  <a onclick="openPrivacy()">Datenschutzhinweis</a>
</div>

<!-- DSGVO POPUP -->
<div id="privacyBox">
  <h3>Datenschutzhinweis</h3>
  <p>
  Die gezeigten Daten sind vollständig anonymisiert und in Hexagon-Flächen aggregiert.
  Einzelpersonen oder Hausadressen sind zu keinem Zeitpunkt identifizierbar.
  </p>
  <button onclick="closePrivacy()">Schließen</button>
</div>


<script>
/* ------------------------------------------------------ */
/* PRIVACY HANDLER                                        */
/* ------------------------------------------------------ */
function openPrivacy(){ document.getElementById("privacyBox").style.display="block"; }
function closePrivacy(){ document.getElementById("privacyBox").style.display="none"; }

/* ------------------------------------------------------ */
/* MAP INIT                                               */
/* ------------------------------------------------------ */
const map = L.map('map', {
  preferCanvas: true,
  inertia: false,
  center: [53.699327, 10.774143],
  zoom: 10
});

const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map);

const darkTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19});

let dark = false;

/* ------------------------------------------------------ */
/* DARK MODE BUTTON                                       */
/* ------------------------------------------------------ */
document.getElementById("btnDark").onclick = () => {
  if(!dark){
    map.removeLayer(lightTiles); darkTiles.addTo(map);
    dark = true;
    btnDark.innerHTML="Light Mode";
  } else {
    map.removeLayer(darkTiles); lightTiles.addTo(map);
    dark = false;
    btnDark.innerHTML="Dark Mode";
  }
};

/* ------------------------------------------------------ */
/* COLOR SCALE                                            */
/* ------------------------------------------------------ */
function getColor(count){
  return count > 25 ? '#440154' :
         count > 15 ? '#414487' :
         count > 10 ? '#2A788E' :
         count > 5  ? '#22A884' :
         count > 2  ? '#7AD151' :
         count > 0  ? '#FDE725' :
                      '#FDE725';
}

function formatCount(c){
  if(c <= 2) return "0–2";
  if(c <= 5) return "3–5";
  if(c <= 10) return "6–10";
  if(c <= 15) return "11–15";
  if(c <= 25) return "16–25";
  return "25+";
}

/* ------------------------------------------------------ */
/* GEOJSON LAYER LOAD                                     */
/* ------------------------------------------------------ */
const layer7 = L.layerGroup();
const layer8 = L.layerGroup();

function loadLayer(file, intoLayer){
  fetch(file).then(r=>r.json()).then(data=>{
    L.geoJSON(data,{
      style: f => ({
        fillColor:getColor(f.properties.count),
        color:"#222",
        weight:1.2,
        fillOpacity:0.45
      }),
      onEachFeature: (f, layer)=>{
        layer.bindTooltip("Teilnehmer: " + formatCount(f.properties.count),{sticky:true});
      }
    }).addTo(intoLayer);
  });
}

loadLayer("hexagons_r7.geojson", layer7);
loadLayer("hexagons_r8.geojson", layer8);

layer8.addTo(map);   // background
layer7.addTo(map);   // front


/* keep r7 always above r8 */
layer7.eachLayer(l => l.setZIndex(10));
layer8.eachLayer(l => l.setZIndex(1));

/* ------------------------------------------------------ */
/* BUTTONS FOR LAYER SWITCHING                            */
/* ------------------------------------------------------ */
document.getElementById("btnR7").onclick = () => {
  btnR7.classList.add("active");
  btnR8.classList.remove("active");
  layer7.addTo(map);
  layer8.addTo(map);
};

document.getElementById("btnR8").onclick = () => {
  btnR7.classList.remove("active");
  btnR8.classList.add("active");
  layer8.addTo(map);
  layer7.addTo(map);
};


/* ------------------------------------------------------ */
/* LEGEND                                                 */
/* ------------------------------------------------------ */
const legend = L.control({position:"bottomright"});
legend.onAdd = function(){
  const div = L.DomUtil.create("div","legend");
  const ranges = [
    [0,"0–2"],
    [3,"3–5"],
    [6,"6–10"],
    [11,"11–15"],
    [16,"16–25"],
    [26,"25+"]
  ];

  div.innerHTML="<b>Anmeldungen</b><br>";
  ranges.forEach(([val,label])=>{
    div.innerHTML += `<i style="background:${getColor(val)}"></i>${label}<br>`;
  });

  return div;
};
legend.addTo(map);

</script>
</body>
</html>
